<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Philippine Disaster Rescue System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.95;
        }

        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .stats-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 500;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .stat-badge {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .stat-badge.critical { background: #dc3545; }
        .stat-badge.urgent { background: #fd7e14; }
        .stat-badge.moderate { background: #ffc107; }

        .stat-count {
            color: #333;
            font-weight: 700;
        }

        .fab-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 500;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab.primary {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .fab.secondary {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        }

        .fab.location {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.active {
            transform: translateY(0);
        }

        .sidebar-header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-btn:active {
            background: rgba(255,255,255,0.2);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #dc3545;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .location-toggle {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .location-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .location-btn.active {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .location-info {
            background: #e7f5ff;
            border-left: 4px solid #007bff;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .rescue-list {
            margin-top: 30px;
        }

        .rescue-list h2 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #333;
        }

        .rescue-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #ddd;
        }

        .rescue-item:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .rescue-item.critical {
            border-left-color: #dc3545;
        }

        .rescue-item.urgent {
            border-left-color: #fd7e14;
        }

        .rescue-item.moderate {
            border-left-color: #ffc107;
        }

        .rescue-item-status {
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .rescue-item-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #333;
        }

        .rescue-item-message {
            color: #666;
            font-size: 0.9rem;
            margin: 8px 0;
            line-height: 1.4;
        }

        .rescue-item-location,
        .rescue-item-time {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        .navigate-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .navigate-btn:active {
            transform: scale(0.98);
        }

        .navigation-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
            z-index: 1500;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
        }

        .navigation-panel.active {
            transform: translateY(0);
        }

        .navigation-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 20px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navigation-header h3 {
            font-size: 1.2rem;
        }

        .navigation-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .nav-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .nav-info-icon {
            font-size: 2rem;
            color: #007bff;
        }

        .nav-info-text {
            flex: 1;
        }

        .nav-info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 2px;
        }

        .nav-info-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
        }

        .route-steps {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 2px solid #e9ecef;
        }

        .route-steps h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1rem;
        }

        .route-step {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .route-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-instruction {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .step-distance {
            font-size: 0.85rem;
            color: #666;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-btn.recenter {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .nav-btn.close {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .nav-btn.google {
            background: linear-gradient(135deg, #4285f4 0%, #357ae8 100%);
            color: white;
        }

        .current-direction {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
        }

        .current-direction-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .current-direction-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .current-direction-distance {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .header p {
                font-size: 1rem;
            }

            .stats-bar {
                max-width: 600px;
                margin: 0 auto;
            }

            .sidebar {
                width: 450px;
                left: auto;
                right: 0;
                transform: translateX(100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .fab-container {
                right: 30px;
                bottom: 30px;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                display: flex;
            }

            #map {
                flex: 1;
            }

            .sidebar {
                position: relative;
                transform: translateX(0);
                height: 100%;
                box-shadow: -4px 0 15px rgba(0,0,0,0.1);
                width: 400px;
                flex-shrink: 0;
            }

            .fab-container {
                display: none;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-content {
                padding-top: 0;
            }

            .sidebar-content::before {
                content: '';
                display: block;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-life-ring"></i> PH Disaster Rescue</h1>
            <p>Emergency Response & Coordination Platform</p>
        </div>

        <div class="main-content">
            <div id="map"></div>

            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-badge critical"></span>
                    <span><span class="stat-count" id="criticalCount">0</span></span>
                </div>
                <div class="stat-item">
                    <span class="stat-badge urgent"></span>
                    <span><span class="stat-count" id="urgentCount">0</span></span>
                </div>
                <div class="stat-item">
                    <span class="stat-badge moderate"></span>
                    <span><span class="stat-count" id="moderateCount">0</span></span>
                </div>
            </div>

            <div class="fab-container">
                <button class="fab location" onclick="centerOnUserLocation()" title="My Location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="fab secondary" onclick="toggleSidebar('list')" title="View Requests">
                    <i class="fas fa-list"></i>
                </button>
                <button class="fab primary" onclick="toggleSidebar('report')" title="Report Emergency">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2 id="sidebarTitle"><i class="fas fa-exclamation-triangle"></i> Report Emergency</h2>
                    <button class="close-btn" onclick="closeSidebar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="sidebar-content">
                    <div id="alertContainer"></div>

                    <div id="reportSection">
                        <div class="form-group">
                            <label><i class="fas fa-map-pin"></i> Location Method:</label>
                            <div class="location-toggle">
                                <button type="button" class="location-btn active" id="autoBtn" onclick="switchLocationMethod('auto')">
                                    <i class="fas fa-location-arrow"></i> Auto GPS
                                </button>
                                <button type="button" class="location-btn" id="manualBtn" onclick="switchLocationMethod('manual')">
                                    <i class="fas fa-edit"></i> Manual
                                </button>
                            </div>
                        </div>

                        <div class="location-info" id="locationInfo">
                            <i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> Detecting...
                        </div>

                        <form id="rescueForm">
                            <div class="form-group">
                                <label for="status"><i class="fas fa-exclamation-circle"></i> Emergency Status *</label>
                                <select id="status" name="status" required>
                                    <option value="">-- Select Status --</option>
                                    <option value="Critical">🔴 Critical - Life Threatening</option>
                                    <option value="Urgent">🟠 Urgent - Immediate Help</option>
                                    <option value="Moderate">🟡 Moderate - Assistance Required</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="name"><i class="fas fa-user"></i> Your Name *</label>
                                <input type="text" id="name" name="name" required placeholder="Enter your full name">
                            </div>

                            <div class="form-group">
                                <label for="contact"><i class="fas fa-phone"></i> Contact Number</label>
                                <input type="tel" id="contact" name="contact" placeholder="+63 912 345 6789">
                            </div>

                            <div class="form-group">
                                <label for="message"><i class="fas fa-comment-dots"></i> Emergency Details *</label>
                                <textarea id="message" name="message" required placeholder="Describe your situation..."></textarea>
                            </div>

                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                            <input type="hidden" id="address" name="address">

                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Emergency Alert
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">
                                <i class="fas fa-sync-alt"></i> Refresh Location
                            </button>
                        </form>
                    </div>

                    <div class="rescue-list" id="rescueListSection">
                        <h2><i class="fas fa-list-ul"></i> Active Rescue Requests</h2>
                        <div id="rescueListContainer"></div>
                    </div>
                </div>
            </div>

            <div class="navigation-panel" id="navigationPanel">
                <div class="navigation-header">
                    <h3><i class="fas fa-route"></i> Navigation</h3>
                    <button class="close-btn" onclick="closeNavigation()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="navigation-content">
                    <div class="nav-info">
                        <div class="nav-info-icon">
                            <i class="fas fa-map-marked-alt"></i>
                        </div>
                        <div class="nav-info-text">
                            <div class="nav-info-label">Distance</div>
                            <div class="nav-info-value" id="navDistance">-- km</div>
                        </div>
                    </div>

                    <div class="nav-info">
                        <div class="nav-info-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="nav-info-text">
                            <div class="nav-info-label">Est. Travel Time</div>
                            <div class="nav-info-value" id="navTime">-- min</div>
                        </div>
                    </div>

                    <div id="navDetails"></div>

                    <div class="nav-actions">
                        <button class="nav-btn recenter" onclick="recenterMap()">
                            <i class="fas fa-crosshairs"></i> Recenter
                        </button>
                        <button class="nav-btn google" onclick="openInMaps()">
                            <i class="fas fa-external-link-alt"></i> Google
                        </button>
                        <button class="nav-btn close" onclick="closeNavigation()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBsX2Q38s75vQPyfbsQKWOmbMshPDG1DbQ",
            authDomain: "phdisaster-f273b.firebaseapp.com",
            databaseURL: "https://phdisaster-f273b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "phdisaster-f273b",
            storageBucket: "phdisaster-f273b.firebasestorage.app",
            messagingSenderId: "843015268105",
            appId: "1:843015268105:web:b3da3a6d7263c95dba55d8",
            measurementId: "G-HBW10MV98Y"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const rescuesRef = ref(database, 'rescues');

        const map = L.map('map').setView([12.8797, 121.7740], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        const getMarkerIcon = (status) => {
            const colors = {
                'Critical': '#dc3545',
                'Urgent': '#fd7e14',
                'Moderate': '#ffc107'
            };
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${colors[status]}; width: 35px; height: 35px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">!</div>`,
                iconSize: [35, 35],
                iconAnchor: [17, 17]
            });
        };

        let userMarker = null;
        let userLocation = null;
        let rescueRequests = {};
        let markers = {};
        let routingLine = null;
        let currentNavigation = null;

        onValue(rescuesRef, (snapshot) => {
            rescueRequests = {};
            Object.values(markers).forEach(marker => map.removeLayer(marker));
            markers = {};

            if (snapshot.exists()) {
                const data = snapshot.val();
                Object.keys(data).forEach(key => {
                    const request = { ...data[key], id: key };
                    rescueRequests[key] = request;
                    if (request.latitude && request.longitude) {
                        addRescueMarker(request);
                    }
                });
            }

            updateRescueList();
            updateStats();
        });

        function updateStats() {
            const stats = { Critical: 0, Urgent: 0, Moderate: 0 };
            Object.values(rescueRequests).forEach(req => {
                if (stats[req.status] !== undefined) stats[req.status]++;
            });
            document.getElementById('criticalCount').textContent = stats.Critical;
            document.getElementById('urgentCount').textContent = stats.Urgent;
            document.getElementById('moderateCount').textContent = stats.Moderate;
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                showAlert('Detecting your location...', 'info');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        userLocation = { lat, lng };

                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;

                        map.setView([lat, lng], 16);

                        if (userMarker) map.removeLayer(userMarker);
                        if (window.accuracyCircle) map.removeLayer(window.accuracyCircle);

                        window.accuracyCircle = L.circle([lat, lng], {
                            radius: position.coords.accuracy,
                            color: '#4285f4',
                            fillColor: '#4285f4',
                            fillOpacity: 0.15,
                            weight: 2
                        }).addTo(map);

                        userMarker = L.marker([lat, lng], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNSIgaGVpZ2h0PSI0NSIgdmlld0JveD0iMCAwIDM1IDQ1Ij48cGF0aCBmaWxsPSIjNDI4NWY0IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTE3LjUgMEM5LjUgMCA1IDYuNSA1IDEyYzAgOSAxMi41IDI1IDEyLjUgMjVTMzAgMjEgMzAgMTJjMC01LjUtNC41LTEyLTEyLjUtMTJ6bTAgMThjLTMuMyAwLTYtMi43LTYtNnMyLjctNiA2LTYgNiAyLjcgNiA2LTIuNyA2LTYgNnoiLz48L3N2Zz4=',
                                iconSize: [35, 45],
                                iconAnchor: [17, 45]
                            })
                        }).addTo(map);

                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                            .then(response => response.json())
                            .then(data => {
                                const address = data.display_name || `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                                document.getElementById('address').value = address;
                                document.getElementById('locationInfo').innerHTML = `<i class="fas fa-check-circle"></i> <strong>Location:</strong> ${address}`;
                                showAlert('Location detected successfully!', 'success');
                            })
                            .catch(() => {
                                const coords = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                                document.getElementById('address').value = coords;
                                document.getElementById('locationInfo').innerHTML = `<i class="fas fa-check-circle"></i> <strong>Location:</strong> ${coords}`;
                                showAlert('Location detected!', 'success');
                            });
                    },
                    (error) => {
                        showAlert('Unable to get location. Please enable permissions or enter manually.', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            } else {
                showAlert('Geolocation not supported. Please enter location manually.', 'error');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            alert.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        document.getElementById('rescueForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = {
                status: document.getElementById('status').value,
                name: document.getElementById('name').value,
                contact: document.getElementById('contact').value,
                message: document.getElementById('message').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                address: document.getElementById('address').value,
                timestamp: new Date().toISOString()
            };

            if (!formData.latitude || !formData.longitude) {
                showAlert('Please allow location access or enter manually.', 'error');
                return;
            }

            showAlert('Sending emergency alert...', 'info');
            const newRescueRef = push(rescuesRef);
            set(newRescueRef, formData)
                .then(() => {
                    showAlert('✓ Emergency alert sent successfully!', 'success');
                    document.getElementById('rescueForm').reset();
                    setTimeout(() => closeSidebar(), 2000);
                })
                .catch((error) => {
                    console.error('Firebase error:', error);
                    showAlert('Error submitting request. Please try again.', 'error');
                });
        });

        function addRescueMarker(data) {
            const marker = L.marker([data.latitude, data.longitude], { 
                icon: getMarkerIcon(data.status) 
            }).addTo(map);

            const contactInfo = data.contact ? `<p style="margin: 5px 0;"><i class="fas fa-phone"></i> <strong>Contact:</strong> ${data.contact}</p>` : '';

            marker.bindPopup(`
                <div style="min-width: 250px; max-width: 300px;">
                    <h3 style="margin: 0 0 12px 0; color: #333; border-bottom: 2px solid ${getStatusColor(data.status)}; padding-bottom: 8px;">
                        <i class="fas fa-exclamation-triangle"></i> ${data.status} Emergency
                    </h3>
                    <p style="margin: 8px 0;"><i class="fas fa-user"></i> <strong>Name:</strong> ${data.name}</p>
                    ${contactInfo}
                    <p style="margin: 8px 0;"><i class="fas fa-comment-dots"></i> <strong>Details:</strong> ${data.message}</p>
                    <p style="margin: 8px 0; font-size: 0.9em; color: #666;"><i class="fas fa-map-marker-alt"></i> ${data.address || 'Lat: ' + data.latitude.toFixed(5) + ', Lng: ' + data.longitude.toFixed(5)}</p>
                    <p style="margin: 8px 0 0 0; font-size: 0.85em; color: #888;"><i class="far fa-clock"></i> ${new Date(data.timestamp).toLocaleString('en-PH', { dateStyle: 'medium', timeStyle: 'short' })}</p>
                    <button onclick="startNavigation('${data.id}')" style="width: 100%; margin-top: 10px; padding: 10px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-directions"></i> Navigate Here
                    </button>
                </div>
            `);

            markers[data.id] = marker;
        }

        function setManualLocation(lat, lng, address) {
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            document.getElementById('address').value = address;
            userLocation = { lat, lng };

            map.setView([lat, lng], 16);

            if (userMarker) map.removeLayer(userMarker);
            if (window.accuracyCircle) map.removeLayer(window.accuracyCircle);

            userMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNSIgaGVpZ2h0PSI0NSIgdmlld0JveD0iMCAwIDM1IDQ1Ij48cGF0aCBmaWxsPSIjNDI4NWY0IiBzdHJva2U9IiNmZmYiIHN0cm9rZS13aWR0aD0iMiIgZD0iTTE3LjUgMEM5LjUgMCA1IDYuNSA1IDEyYzAgOSAxMi41IDI1IDEyLjUgMjVTMzAgMjEgMzAgMTJjMC01LjUtNC41LTEyLTEyLjUtMTJ6bTAgMThjLTMuMyAwLTYtMi43LTYtNnMyLjctNiA2LTYgNiAyLjcgNiA2LTIuNyA2LTYgNnoiLz48L3N2Zz4=',
                    iconSize: [35, 45],
                    iconAnchor: [17, 45]
                })
            }).addTo(map);

            showAlert(`✓ Location set: ${address}`, 'success');
        }

        function updateRescueList() {
            const container = document.getElementById('rescueListContainer');
            const requestsArray = Object.values(rescueRequests);

            if (requestsArray.length === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center; padding: 30px; font-style: italic;"><i class="fas fa-info-circle"></i> No active rescue requests</p>';
                return;
            }

            container.innerHTML = '';
            const sortedRequests = [...requestsArray].sort((a, b) => {
                const priority = { Critical: 0, Urgent: 1, Moderate: 2 };
                return priority[a.status] - priority[b.status];
            });

            sortedRequests.forEach((request) => {
                const lat = parseFloat(request.latitude);
                const lng = parseFloat(request.longitude);

                const item = document.createElement('div');
                item.className = `rescue-item ${request.status.toLowerCase()}`;

                const contactInfo = request.contact ? `<div style="margin-top: 5px; font-size: 0.85em; color: #666;"><i class="fas fa-phone"></i> ${request.contact}</div>` : '';

                item.innerHTML = `
                    <div class="rescue-item-status" style="color: ${getStatusColor(request.status)}">
                        <i class="fas fa-circle"></i> ${request.status.toUpperCase()}
                    </div>
                    <div class="rescue-item-name"><i class="fas fa-user"></i> ${request.name}</div>
                    ${contactInfo}
                    <div class="rescue-item-message"><i class="fas fa-comment-dots"></i> ${request.message}</div>
                    <div class="rescue-item-location"><i class="fas fa-map-marker-alt"></i> ${request.address || 'Lat: ' + lat.toFixed(4) + ', Lng: ' + lng.toFixed(4)}</div>
                    <div class="rescue-item-time"><i class="far fa-clock"></i> ${new Date(request.timestamp).toLocaleString('en-PH', { dateStyle: 'medium', timeStyle: 'short' })}</div>
                `;

                item.onclick = () => {
                    map.setView([lat, lng], 16);
                    if (markers[request.id]) {
                        markers[request.id].openPopup();
                    }
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                };

                const navBtn = document.createElement('button');
                navBtn.className = 'navigate-btn';
                navBtn.innerHTML = '<i class="fas fa-directions"></i> Navigate to Victim';
                navBtn.onclick = (e) => {
                    e.stopPropagation();
                    startNavigation(request.id);
                };
                item.appendChild(navBtn);

                container.appendChild(item);
            });
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Critical': return '#dc3545';
                case 'Urgent': return '#fd7e14';
                case 'Moderate': return '#ffc107';
                default: return '#666';
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        window.startNavigation = function(requestId) {
            const request = rescueRequests[requestId];
            if (!request) return;

            if (!userLocation) {
                showAlert('Please enable location to use navigation.', 'error');
                getCurrentLocation();
                return;
            }

            currentNavigation = {
                id: requestId,
                destination: { lat: request.latitude, lng: request.longitude },
                name: request.name,
                address: request.address,
                status: request.status
            };

            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                request.latitude, request.longitude
            );

            const avgSpeed = 40;
            const estimatedTime = (distance / avgSpeed) * 60;

            document.getElementById('navDistance').textContent = distance.toFixed(2) + ' km';
            document.getElementById('navTime').textContent = Math.ceil(estimatedTime) + ' min';

            // Calculate bearing for direction
            const bearing = calculateBearing(
                userLocation.lat, userLocation.lng,
                request.latitude, request.longitude
            );
            const direction = getDirection(bearing);

            // Generate route steps
            const steps = generateRouteSteps(userLocation, currentNavigation.destination, distance);

            document.getElementById('navDetails').innerHTML = `
                <div class="current-direction">
                    <div class="current-direction-icon">
                        <i class="fas fa-arrow-up" style="transform: rotate(${bearing}deg);"></i>
                    </div>
                    <div class="current-direction-text">Head ${direction}</div>
                    <div class="current-direction-distance">towards ${request.name}</div>
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;"><i class="fas fa-user"></i> ${request.name}</h4>
                    <p style="margin: 5px 0; color: #666; font-size: 0.9rem;"><i class="fas fa-map-marker-alt"></i> ${request.address || 'Coordinates: ' + request.latitude.toFixed(5) + ', ' + request.longitude.toFixed(5)}</p>
                    <p style="margin: 10px 0 5px 0; color: ${getStatusColor(request.status)}; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> ${request.status} Emergency</p>
                </div>

                <div class="route-steps">
                    <h4><i class="fas fa-route"></i> Route Instructions</h4>
                    ${steps.map((step, index) => `
                        <div class="route-step">
                            <div class="step-icon">
                                <i class="fas ${step.icon}"></i>
                            </div>
                            <div class="step-content">
                                <div class="step-instruction">${step.instruction}</div>
                                <div class="step-distance">${step.distance}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            if (routingLine) {
                map.removeLayer(routingLine);
            }

            routingLine = L.polyline([
                [userLocation.lat, userLocation.lng],
                [request.latitude, request.longitude]
            ], {
                color: '#007bff',
                weight: 5,
                opacity: 0.8,
                dashArray: '10, 10'
            }).addTo(map);

            const bounds = L.latLngBounds([
                [userLocation.lat, userLocation.lng],
                [request.latitude, request.longitude]
            ]);
            map.fitBounds(bounds, { padding: [50, 50] });

            document.getElementById('navigationPanel').classList.add('active');

            if (window.innerWidth < 1024) {
                closeSidebar();
            }

            // Start tracking user location during navigation
            startLocationTracking();
        };

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
            const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
                      Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            return bearing;
        }

        function getDirection(bearing) {
            const directions = ['North', 'Northeast', 'East', 'Southeast', 'South', 'Southwest', 'West', 'Northwest'];
            const index = Math.round(bearing / 45) % 8;
            return directions[index];
        }

        function generateRouteSteps(start, end, totalDistance) {
            const bearing = calculateBearing(start.lat, start.lng, end.lat, end.lng);
            const direction = getDirection(bearing);
            
            const steps = [
                {
                    icon: 'fa-location-arrow',
                    instruction: `Start from your current location`,
                    distance: 'Current position'
                },
                {
                    icon: 'fa-compass',
                    instruction: `Head ${direction} on your current road`,
                    distance: `Continue for ${(totalDistance * 0.3).toFixed(2)} km`
                }
            ];

            // Add intermediate step if distance is more than 2km
            if (totalDistance > 2) {
                steps.push({
                    icon: 'fa-road',
                    instruction: `Continue straight towards destination`,
                    distance: `${(totalDistance * 0.5).toFixed(2)} km remaining`
                });
            }

            // Add final step
            steps.push({
                icon: 'fa-flag-checkered',
                instruction: `Arrive at ${currentNavigation.name}'s location`,
                distance: 'Destination'
            });

            return steps;
        }

        let locationWatcher = null;

        function startLocationTracking() {
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
            }

            if (navigator.geolocation) {
                locationWatcher = navigator.geolocation.watchPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        userLocation = { lat, lng };

                        // Update user marker
                        if (userMarker) {
                            userMarker.setLatLng([lat, lng]);
                        }

                        if (window.accuracyCircle) {
                            window.accuracyCircle.setLatLng([lat, lng]);
                            window.accuracyCircle.setRadius(position.coords.accuracy);
                        }

                        // Update navigation if active
                        if (currentNavigation && document.getElementById('navigationPanel').classList.contains('active')) {
                            updateNavigationInfo();
                        }
                    },
                    (error) => {
                        console.error('Location tracking error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 5000,
                        timeout: 10000
                    }
                );
            }
        }

        function updateNavigationInfo() {
            if (!currentNavigation || !userLocation) return;

            const distance = calculateDistance(
                userLocation.lat, userLocation.lng,
                currentNavigation.destination.lat, currentNavigation.destination.lng
            );

            const bearing = calculateBearing(
                userLocation.lat, userLocation.lng,
                currentNavigation.destination.lat, currentNavigation.destination.lng
            );
            const direction = getDirection(bearing);

            document.getElementById('navDistance').textContent = distance.toFixed(2) + ' km';
            
            const avgSpeed = 40;
            const estimatedTime = (distance / avgSpeed) * 60;
            document.getElementById('navTime').textContent = Math.ceil(estimatedTime) + ' min';

            // Update direction arrow
            const arrow = document.querySelector('.current-direction-icon i');
            if (arrow) {
                arrow.style.transform = `rotate(${bearing}deg)`;
            }

            const directionText = document.querySelector('.current-direction-text');
            if (directionText) {
                directionText.textContent = `Head ${direction}`;
            }

            // Update routing line
            if (routingLine) {
                routingLine.setLatLngs([
                    [userLocation.lat, userLocation.lng],
                    [currentNavigation.destination.lat, currentNavigation.destination.lng]
                ]);
            }

            // Check if arrived (within 50 meters)
            if (distance < 0.05) {
                showAlert('✓ You have arrived at the destination!', 'success');
                closeNavigation();
            }
        }

        window.recenterMap = function() {
            if (currentNavigation && userLocation) {
                const bounds = L.latLngBounds([
                    [userLocation.lat, userLocation.lng],
                    [currentNavigation.destination.lat, currentNavigation.destination.lng]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        };

        window.openInMaps = function() {
            if (!currentNavigation) return;

            const dest = currentNavigation.destination;
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${dest.lat},${dest.lng}`;
            
            window.open(mapsUrl, '_blank');
        };

        window.closeNavigation = function() {
            document.getElementById('navigationPanel').classList.remove('active');
            if (routingLine) {
                map.removeLayer(routingLine);
                routingLine = null;
            }
            if (locationWatcher) {
                navigator.geolocation.clearWatch(locationWatcher);
                locationWatcher = null;
            }
            currentNavigation = null;
        };

        window.toggleSidebar = function(section) {
            const sidebar = document.getElementById('sidebar');
            const title = document.getElementById('sidebarTitle');
            const reportSection = document.getElementById('reportSection');
            const listSection = document.getElementById('rescueListSection');

            if (section === 'report') {
                title.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Report Emergency';
                reportSection.style.display = 'block';
                listSection.style.display = 'none';
            } else if (section === 'list') {
                title.innerHTML = '<i class="fas fa-list-ul"></i> Active Rescue Requests';
                reportSection.style.display = 'none';
                listSection.style.display = 'block';
            }

            sidebar.classList.add('active');
        };

        window.closeSidebar = function() {
            document.getElementById('sidebar').classList.remove('active');
        };

        window.centerOnUserLocation = function() {
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 16);
            } else {
                getCurrentLocation();
            }
        };

        window.switchLocationMethod = function(method) {
            const autoBtn = document.getElementById('autoBtn');
            const manualBtn = document.getElementById('manualBtn');
            const locationInfo = document.getElementById('locationInfo');

            if (method === 'auto') {
                autoBtn.classList.add('active');
                manualBtn.classList.remove('active');
                locationInfo.style.display = 'block';

                const manualInputs = document.getElementById('manualLocationInputs');
                if (manualInputs) manualInputs.remove();

                getCurrentLocation();
            } else {
                manualBtn.classList.add('active');
                autoBtn.classList.remove('active');
                locationInfo.style.display = 'none';

                if (!document.getElementById('manualLocationInputs')) {
                    const manualInputsDiv = document.createElement('div');
                    manualInputsDiv.id = 'manualLocationInputs';
                    manualInputsDiv.className = 'form-group';
                    manualInputsDiv.innerHTML = `
                        <label for="manualAddress"><i class="fas fa-search-location"></i> Enter Address or Coordinates</label>
                        <input type="text" id="manualAddress" placeholder="e.g., Cebu City or 10.3157, 123.8854">
                        <button type="button" class="btn btn-success" onclick="searchLocation()" style="margin-top: 10px;">
                            <i class="fas fa-search"></i> Search Location
                        </button>
                    `;

                    const locationMethodDiv = document.querySelector('.location-toggle').parentElement;
                    locationMethodDiv.parentNode.insertBefore(manualInputsDiv, locationMethodDiv.nextSibling);
                }
            }
        };

        window.searchLocation = function() {
            const address = document.getElementById('manualAddress').value.trim();

            if (!address) {
                showAlert('Please enter an address or coordinates.', 'error');
                return;
            }

            showAlert('Searching for location...', 'info');

            const coordPattern = /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/;
            if (coordPattern.test(address)) {
                const [lat, lng] = address.split(',').map(s => parseFloat(s.trim()));
                if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    setManualLocation(lat, lng, `Coordinates: ${lat.toFixed(5)}, ${lng.toFixed(5)}`);
                } else {
                    showAlert('Invalid coordinates. Lat: -90 to 90, Lng: -180 to 180.', 'error');
                }
            } else {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=ph&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            const displayName = data[0].display_name;
                            setManualLocation(lat, lng, displayName);
                        } else {
                            showAlert('Location not found in the Philippines. Try different address or coordinates.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        showAlert('Error searching location. Check internet or use coordinates.', 'error');
                    });
            }
        };

        getCurrentLocation();
    </script>
</body>
</html>